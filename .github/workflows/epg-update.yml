name: Auto-update EPG

on:
  schedule:
    - cron: "0 * * * *"   # hourly
  workflow_dispatch:

concurrency:
  group: epg-update
  cancel-in-progress: false

jobs:
  update-epg:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Git identity
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Download EPG sources
        run: |
          set +e
          echo "üîÑ Starting EPG sync..."

          mkdir -p sources
          SUCCESS=0

          # -----------------------------
          # 1Ô∏è‚É£ IPTV-ORG: all site XMLs
          # -----------------------------
          echo "üì° Fetching iptv-org site EPGs..."

          SITE_LIST=$(curl -fsSL \
            https://api.github.com/repos/iptv-org/epg/contents/sites \
            | jq -r '.[] | select(.name | endswith(".xml")) | .download_url')

          if [ -n "$SITE_LIST" ]; then
            for url in $SITE_LIST; do
              file="sources/iptv-org-$(basename "$url")"
              if curl -fsSL "$url" -o "$file"; then
                echo "‚úÖ $(basename "$file")"
                SUCCESS=$((SUCCESS+1))
              fi
            done
          else
            echo "‚ö†Ô∏è  Could not retrieve iptv-org site list"
          fi

          # --------------------------------------
          # 2Ô∏è‚É£ EPGSHARE master (gzipped)
          # --------------------------------------
          echo "üì¶ Fetching epgshare master feed..."

          if curl -fsSL https://epgshare01.online/epgshare01/epg_ripper_ALL_SOURCES1.xml.gz -o sources/epgshare.xml.gz; then
            gunzip -f sources/epgshare.xml.gz
            echo "‚úÖ epgshare.xml"
            SUCCESS=$((SUCCESS+1))
          else
            echo "‚ö†Ô∏è  Could not load epgshare master feed"
            rm -f sources/epgshare.xml.gz
          fi

          # -----------------------------
          # Nothing downloaded
          # -----------------------------
          if [ "$SUCCESS" -eq 0 ]; then
            echo "üü° No EPG sources available ‚Äî exiting cleanly"
            exit 0
          fi

          echo "‚úÖ Sources downloaded: $SUCCESS"

      - name: Merge EPG XMLs
        run: |
          echo "üîß Merging EPG files..."

          # Example merge using xmlstarlet (simple concat under <tv>)
          sudo apt-get update -qq
          sudo apt-get install -y xmlstarlet

          echo '<tv>' > epg.xml

          for f in sources/*.xml; do
            xmlstarlet sel -t -c "/tv/*" "$f" >> epg.xml || true
          done

          echo '</tv>' >> epg.xml

          echo "‚úÖ EPG merge complete"

      - name: Commit changes
        run: |
          git add epg.xml
          git commit -m "ü§ñ Auto-update EPG - $(date -u '+%Y-%m-%d %H:%M UTC')" || echo "No changes to commit"

      - name: Rebase and push
        run: |
          git pull --rebase origin master
          git push origin master
