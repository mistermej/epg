name: Smart EPG Generator - Multi-Source (Fixed)

on:
  schedule:
    - cron: '0 3 * * *'  # Daily at 3 AM UTC
  workflow_dispatch:

jobs:
  generate-smart-epg:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js (v22 for epg-grabber)
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Download EPGShare01 (Primary Source)
        run: |
          echo "üì• Downloading EPGShare01 comprehensive EPG..."
          wget -O epgshare.xml.gz https://epgshare01.online/epgshare01/epg_ripper_ALL_SOURCES1.xml.gz
          
          if [ -f epgshare.xml.gz ]; then
            echo "‚úÖ Downloaded EPGShare01 successfully"
            gunzip -c epgshare.xml.gz > epgshare.xml
            
            CHANNELS=$(grep -c '<channel' epgshare.xml || echo "0")
            PROGRAMMES=$(grep -c '<programme' epgshare.xml || echo "0")
            echo "üìä EPGShare01 Stats: $CHANNELS channels, $PROGRAMMES programmes"
          else
            echo "‚ùå Failed to download EPGShare01"
            touch epgshare.xml  # Create empty file to continue
          fi
      
      - name: Clone iptv-org/epg
        run: |
          echo "üì• Cloning iptv-org/epg repository..."
          git clone --depth 1 https://github.com/iptv-org/epg.git iptv-epg-repo
          cd iptv-epg-repo
          npm install
      
      - name: Use European channels list
        run: |
          echo "üìã Using pre-configured European channels list..."
          
          # Check if european-channels-massive.xml exists in repo
          if [ -f european-channels-massive.xml ]; then
            echo "‚úÖ Found european-channels-massive.xml in repo"
            cp european-channels-massive.xml auto-channels.xml
          else
            echo "üìù Creating European channels configuration..."
            
            # Create a focused European channels list
            cat > auto-channels.xml << 'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<channels>
  <!-- Netherlands - Key Channels -->
  <channel site="delta.nl" lang="nl" xmltv_id="NPO1.nl">NPO 1</channel>
  <channel site="delta.nl" lang="nl" xmltv_id="NPO2.nl">NPO 2</channel>
  <channel site="delta.nl" lang="nl" xmltv_id="NPO3.nl">NPO 3</channel>
  <channel site="delta.nl" lang="nl" xmltv_id="RTL4.nl">RTL 4</channel>
  <channel site="delta.nl" lang="nl" xmltv_id="RTL5.nl">RTL 5</channel>
  <channel site="delta.nl" lang="nl" xmltv_id="SBS6.nl">SBS6</channel>
  
  <!-- UK - Key Channels -->
  <channel site="sky.com" lang="en" xmltv_id="BBCOne.uk">BBC One</channel>
  <channel site="sky.com" lang="en" xmltv_id="BBCTwo.uk">BBC Two</channel>
  <channel site="sky.com" lang="en" xmltv_id="ITV1.uk">ITV1</channel>
  <channel site="sky.com" lang="en" xmltv_id="Channel4.uk">Channel 4</channel>
  <channel site="sky.com" lang="en" xmltv_id="Channel5.uk">Channel 5</channel>
  
  <!-- Add more channels as needed -->
</channels>
EOF
          fi
      
      - name: Generate supplementary EPG
        run: |
          echo "üì• Generating supplementary EPG from iptv-org..."
          cd iptv-epg-repo
          
          if [ -f ../auto-channels.xml ]; then
            echo "Running EPG grabber with custom channels..."
            npm run grab -- --channels=../auto-channels.xml --days=2 --maxConnections=5 --output=../iptv-org-epg.xml 2>&1 || echo "‚ö†Ô∏è EPG grab had issues, continuing..."
          else
            echo "‚ö†Ô∏è No channels file found, skipping iptv-org grab"
          fi
          
          cd ..
          
          if [ -f iptv-org-epg.xml ] && [ -s iptv-org-epg.xml ]; then
            CHANNELS=$(grep -c '<channel' iptv-org-epg.xml || echo "0")
            PROGRAMMES=$(grep -c '<programme' iptv-org-epg.xml || echo "0")
            echo "üìä iptv-org EPG Stats: $CHANNELS channels, $PROGRAMMES programmes"
          else
            echo "‚ÑπÔ∏è No additional EPG data generated from iptv-org"
            echo '<?xml version="1.0" encoding="UTF-8"?><tv></tv>' > iptv-org-epg.xml
          fi
      
      - name: Merge EPG sources
        run: |
          echo "üîÑ Merging EPG sources..."
          
          # Install Python XML library
          pip install lxml --break-system-packages
          
          # Create merge script
          cat > merge-epg.py << 'PYTHON'
import xml.etree.ElementTree as ET
from datetime import datetime
import os

def merge_epg_files(primary_file, secondary_file, output_file):
    """Merge two EPG files intelligently"""
    
    print("üîÑ Starting EPG merge...")
    
    # Parse primary EPG
    try:
        primary_tree = ET.parse(primary_file)
        primary_root = primary_tree.getroot()
        print(f"‚úÖ Loaded primary EPG: {primary_file}")
        
        primary_channels = len(primary_root.findall('channel'))
        primary_programmes = len(primary_root.findall('programme'))
        print(f"   Primary: {primary_channels} channels, {primary_programmes} programmes")
    except Exception as e:
        print(f"‚ùå Error loading {primary_file}: {e}")
        primary_root = ET.Element('tv')
        primary_root.set('date', datetime.now().strftime('%Y%m%d'))
    
    # Parse secondary EPG
    try:
        secondary_tree = ET.parse(secondary_file)
        secondary_root = secondary_tree.getroot()
        print(f"‚úÖ Loaded secondary EPG: {secondary_file}")
        
        secondary_channels = len(secondary_root.findall('channel'))
        secondary_programmes = len(secondary_root.findall('programme'))
        print(f"   Secondary: {secondary_channels} channels, {secondary_programmes} programmes")
        
        if secondary_channels == 0 and secondary_programmes == 0:
            print("‚ÑπÔ∏è  Secondary EPG is empty, using only primary")
            tree = ET.ElementTree(primary_root)
            tree.write(output_file, encoding='UTF-8', xml_declaration=True)
            return
    except Exception as e:
        print(f"‚ö†Ô∏è  Could not load {secondary_file}: {e}")
        tree = ET.ElementTree(primary_root)
        tree.write(output_file, encoding='UTF-8', xml_declaration=True)
        return
    
    # Get all channel IDs from primary
    primary_channel_ids = set()
    for channel in primary_root.findall('channel'):
        channel_id = channel.get('id')
        if channel_id:
            primary_channel_ids.add(channel_id)
    
    # Add missing channels from secondary
    added_channels = 0
    for channel in secondary_root.findall('channel'):
        channel_id = channel.get('id')
        if channel_id and channel_id not in primary_channel_ids:
            primary_root.append(channel)
            primary_channel_ids.add(channel_id)
            added_channels += 1
    
    # Add missing programmes from secondary
    primary_programme_keys = set()
    for programme in primary_root.findall('programme'):
        key = f"{programme.get('channel')}_{programme.get('start')}_{programme.get('stop')}"
        primary_programme_keys.add(key)
    
    added_programmes = 0
    for programme in secondary_root.findall('programme'):
        key = f"{programme.get('channel')}_{programme.get('start')}_{programme.get('stop')}"
        if key not in primary_programme_keys:
            primary_root.append(programme)
            primary_programme_keys.add(key)
            added_programmes += 1
    
    if added_channels > 0 or added_programmes > 0:
        print(f"‚ú® Added {added_channels} channels and {added_programmes} programmes")
    else:
        print("‚ÑπÔ∏è  No new content to add from secondary source")
    
    # Write merged EPG
    tree = ET.ElementTree(primary_root)
    tree.write(output_file, encoding='UTF-8', xml_declaration=True)
    
    # Final stats
    final_channels = len(primary_root.findall('channel'))
    final_programmes = len(primary_root.findall('programme'))
    print(f"üìä Final: {final_channels} channels, {final_programmes} programmes")

if __name__ == '__main__':
    merge_epg_files('epgshare.xml', 'iptv-org-epg.xml', 'guide.xml')
PYTHON
          
          python3 merge-epg.py
          
          # Create compressed version
          echo "üì¶ Creating compressed version..."
          gzip -c guide.xml > guide.xml.gz
          
          echo "‚úÖ EPG merge complete"
      
      - name: Generate statistics
        run: |
          echo "üìä Generating EPG statistics..."
          
          if [ -f guide.xml ]; then
            TOTAL_CHANNELS=$(grep -c '<channel' guide.xml || echo "0")
            TOTAL_PROGRAMMES=$(grep -c '<programme' guide.xml || echo "0")
            FILE_SIZE=$(stat -f%z guide.xml 2>/dev/null || stat -c%s guide.xml)
            GZ_SIZE=$(stat -f%z guide.xml.gz 2>/dev/null || stat -c%s guide.xml.gz)
            
            cat > EPG_STATS.md << EOF
# üì∫ EPG Statistics

**Last Updated:** $(date -u '+%Y-%m-%d %H:%M UTC')

## üìä Overview
- **Total Channels:** $TOTAL_CHANNELS
- **Total Programmes:** $TOTAL_PROGRAMMES
- **File Size (XML):** $(echo "scale=2; $FILE_SIZE / 1024 / 1024" | bc) MB
- **File Size (GZ):** $(echo "scale=2; $GZ_SIZE / 1024 / 1024" | bc) MB
- **Compression Ratio:** $(echo "scale=1; $FILE_SIZE / $GZ_SIZE" | bc)x

## üåç Sources
1. **EPGShare01** - Primary comprehensive source (24,000+ channels)
2. **iptv-org/epg** - Supplementary European channels

## üì• Usage URLs

### Compressed (Recommended - 10x Smaller!)
\`\`\`
https://raw.githubusercontent.com/$(echo $GITHUB_REPOSITORY)/master/guide.xml.gz
\`\`\`

### Uncompressed
\`\`\`
https://raw.githubusercontent.com/$(echo $GITHUB_REPOSITORY)/master/guide.xml
\`\`\`

## üí° Tips
- Always use the compressed (.gz) version
- File is updated daily at 3 AM UTC
- Includes worldwide channels + European focus
- Compatible with all IPTV players

---
*Generated by Smart EPG Generator*
EOF
            
            echo "‚úÖ Statistics generated"
            cat EPG_STATS.md
          fi
      
      - name: Commit and push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add guide.xml guide.xml.gz EPG_STATS.md 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è  No changes to commit"
          else
            git commit -m "ü§ñ Update EPG - $(date +'%Y-%m-%d %H:%M UTC')

üìä Smart multi-source EPG update
- EPGShare01 (primary comprehensive source)
- iptv-org/epg (supplementary European channels)
            "
            git push
            echo "‚úÖ Changes pushed successfully"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
