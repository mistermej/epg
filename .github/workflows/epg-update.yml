name: Auto-update EPG

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

concurrency:
  group: epg-update
  cancel-in-progress: false

jobs:
  update-epg:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Git identity
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Download EPG sources
        run: |
          set +e
          echo "üîÑ Starting EPG sync..."

          mkdir -p sources
          SUCCESS=0

          # -----------------------------
          # IPTV-ORG: all site XMLs
          # -----------------------------
          echo "üì° Fetching iptv-org site EPGs..."

          SITE_LIST=$(curl -fsSL \
            https://api.github.com/repos/iptv-org/epg/contents/sites \
            | jq -r '.[] | select(.name | endswith(".xml")) | .download_url')

          for url in $SITE_LIST; do
            file="sources/iptv-org-$(basename "$url")"
            if curl -fsSL "$url" -o "$file"; then
              echo "‚úÖ $(basename "$file")"
              SUCCESS=$((SUCCESS+1))
            fi
          done

          # -----------------------------
          # EPGSHARE master feed
          # -----------------------------
          echo "üì¶ Fetching epgshare master feed..."

          if curl -fsSL https://epgshare01.online/epgshare01/epg_ripper_ALL_SOURCES1.xml.gz -o sources/epgshare.xml.gz; then
            gunzip -f sources/epgshare.xml.gz
            echo "‚úÖ epgshare.xml"
            SUCCESS=$((SUCCESS+1))
          else
            echo "‚ö†Ô∏è  Could not load epgshare feed"
          fi

          if [ "$SUCCESS" -eq 0 ]; then
            echo "üü° No EPG sources available ‚Äî exiting cleanly"
            exit 0
          fi

          echo "‚úÖ Sources downloaded: $SUCCESS"

      - name: Merge EPG XMLs
        shell: bash
        run: |
          set -e
          echo "üîß Merging EPG files..."

          OUTPUT="epg.xml"

          echo '<?xml version="1.0" encoding="UTF-8"?>' > "$OUTPUT"
          echo '<tv>' >> "$OUTPUT"

          for f in sources/*.xml; do
            if [ -f "$f" ]; then
              echo "‚ûï Merging $f"
              xmllint --xpath '/tv/*' "$f" 2>/dev/null >> "$OUTPUT" || true
            fi
          done

          echo '</tv>' >> "$OUTPUT"

          echo "‚úÖ EPG merge complete"
- name: Debug EPG file
  run: |
    ls -lh epg.xml
    file epg.xml
